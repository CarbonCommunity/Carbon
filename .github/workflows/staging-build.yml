###
### Copyright (c) 2022 Carbon Community 
### All rights reserved
### 
name: Staging Build
concurrency: build-2-staging

on:
  schedule:
    - cron: '0 5 * * 0'

  push:
    branches:
      - staging

  workflow_dispatch:

jobs:
  bootstrap:
    name: ğŸ¥¾ Bootstrap
    runs-on: ubuntu-latest

    outputs:
      date:  ${{ steps.step1.outputs.date }}
      clock: ${{ steps.step1.outputs.clock }}
      tag:   ${{ steps.step1.outputs.tag }}
      ref:   ${{ steps.step1.outputs.ref }}

    steps:
      #- name: ğŸªµ Log environment
      #  uses: crazy-max/ghaction-dump-context@v1

      - name: ğŸ”— Checkout source code from github
        uses: actions/checkout@v3
        with:
          ref: develop

      - name: ğŸ“… Prepare the environment
        id: step1
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "clock=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT
          echo "tag=$(date +'%Yd%j')" >> $GITHUB_OUTPUT
          echo "ref=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

  build-linux:
    name: ğŸ§ Linux
    needs: bootstrap
    runs-on: ubuntu-latest
    continue-on-error: false

    outputs:
      artifact: build-staging-${{ needs.bootstrap.outputs.ref }}-linux
      build_info: Built at ${{ needs.bootstrap.outputs.date }} ${{ needs.bootstrap.outputs.clock }} based on commit ${{ needs.bootstrap.outputs.ref }}.
    
    steps:
    - name: ğŸ”— Checkout source code from github
      uses: actions/checkout@v3
      with:
        ref: staging

    - name: ğŸ›¤ï¸ Setup the dotnet build environment
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: 6.0.x

    - name: ğŸªš Setup the Carbon build environment
      shell: bash
      run: |
        ${GITHUB_WORKSPACE}/Tools/Build/linux/bootstrap.sh

    - name: ğŸ§ Built Carbon on Linux
      shell: bash
      run: |
        ${GITHUB_WORKSPACE}/Tools/Build/linux/build.sh DebugUnix
        
    - name: â¬†ï¸ Upload the artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-staging-linux
        path: |
          Release/Carbon.DebugUnix.tar.gz
          Release/build-unix.info

  build-windows:
    name: ğŸªŸ Windows
    needs: bootstrap
    runs-on: windows-latest
    
    steps:
    - name: ğŸ”— Checkout source code from github
      uses: actions/checkout@v3
      with:
        ref: staging

    - name: ğŸ›¤ï¸ Setup the dotnet build environment
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: 6.0.x

    - name: ğŸªš Setup the Carbon build environment
      shell: cmd
      run: |
        %GITHUB_WORKSPACE%\Tools\Build\win\bootstrap.bat

    - name: ğŸªŸ Built Carbon on Windows
      shell: cmd
      run: |
        %GITHUB_WORKSPACE%\Tools\Build\win\build.bat Debug

    - name: â¬†ï¸ Upload the artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-staging-windows
        path: |
          Release/Carbon.Debug.zip
          Release/build.info

  release:
    name: ğŸ’¾ Release
    needs: [ "build-linux", "build-windows" ]
    runs-on: ubuntu-latest

    steps:
    - name: â¬‡ï¸ Download artifacts
      uses: actions/download-artifact@v3
      with:
        path: Release/
        
    - name: ğŸ—‘ï¸ Delete existing release tag
      uses: dev-drprasad/delete-tag-and-release@v0.2.0
      with:
        delete_release: true
        tag_name: staging_build
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸ Update release tag
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: true
        tag_name: staging_build
        name: 'Carbon Build (staging)'
        body: |
          This is a development build of Carbon based on the `staging` branch.
          
          This build is targeted at developers.
          The general public is advised to use one of the [stable] builds.

          ### How to install
          1. Download the `Carbon.Debug[Unix]` archive from the attachments below.
          2. Unzip the archive to the root of your Rust Dedicated Server.
          3. Restart the server and enjoy.
          
          ${{ needs.build-linux.outputs.build_info }}

          [stable]: https://github.com/Carbon-Modding/Carbon.Core/releases/latest
        files: |
          Release/build-staging-windows/Carbon.Debug.zip
          Release/build-staging-linux/Carbon.DebugUnix.tar.gz
          Release/build-staging-linux/build-unix.info
          Release/build-staging-windows/build.info
